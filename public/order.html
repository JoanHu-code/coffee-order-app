<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å’–å•¡è¨‚è³¼ï½œDawit's Coffee</title>
  <style>
    :root { --bg:#0f0f11; --card:#16171a; --muted:#a7aab0; --text:#e9eaee; --accent:#8bdc6e; --accent-2:#7ab7ff; --danger:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"PingFang TC","Microsoft JhengHei",Arial; background:radial-gradient(1200px 600px at 20% 0%, #14161a 0%, var(--bg) 70%); color:var(--text)}
    a{color:inherit}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:16px}
    .title{font-size:28px;font-weight:800;letter-spacing:.5px}
    .pill{background:#1e2025;border:1px solid #2a2d33;padding:6px 12px;border-radius:999px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .card{background:var(--card);border:1px solid #2a2d33;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}

    /* Tabs + menu cards */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tab{padding:8px 12px;border-radius:12px;border:1px solid #2a2d33;background:#1e2025;color:#cfd2d8;font-weight:700;cursor:pointer}
    .tab.active{background:#2a2d33;color:#fff}
    .menu-panel{display:none}
    .menu-panel.active{display:block}
    .menu-list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .menu-item{background:#191b20;border:1px solid #2a2d33;border-radius:14px;padding:12px}
    .menu-item .line{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .menu-item .price{font-weight:800}
    .menu-item .buyline{display:flex;gap:8px;align-items:center;margin-top:8px}
    .menu-item input[type=number]{width:80px;text-align:center}

    /* èª¿æ•´æ•¸é‡æ§åˆ¶æ›è¡Œ */
   .qty {
        display: flex;
        flex-direction: row; /* æ°´å¹³æ’åˆ— */
        justify-content: center; /* æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†ç½®ä¸­ */
        gap: 4px;
        width: 100%; /* å æ»¿æ•´è¡Œ */
        margin-top: 8px;
      }
      .qty button{
        flex: 1; /* ä¸‰å€‹å…ƒä»¶å¹³å‡åˆ†é…å¯¬åº¦ */
      }
       .qty input {
        flex: 5; /* ä¸‰å€‹å…ƒä»¶å¹³å‡åˆ†é…å¯¬åº¦ */
      }
    .top{display:flex;gap:12px;align-items:center}
    .img{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#2b2e35,#1f2228);display:grid;place-items:center;font-size:26px}
    .meta{flex:1}
    .bottom{display:flex;justify-content:space-between;align-items:center;margin-top:8px}

    button,.btn{padding:8px 12px;border-radius:12px;border:1px solid #2a2d33;background:#20232a;color:var(--text);cursor:pointer;font-weight:600;transition:all .15s ease}
    .btn-add{background:#1d2b21;border-color:#2d4533}
    .btn-add:hover{background:#243628}
    .btn-danger{background:#2b1f1f;border-color:#4a2a2a;color:#ffb3b3}
    .btn-danger:hover{background:#3a2525}
      /* è®“åŠ å…¥æŒ‰éˆ•å æ»¿ä¸€æ•´è¡Œ */
      .bottom .btn-add {
        width: 100%;
      }
    .cart-list{display:grid;gap:10px;margin:10px 0 16px}
    .cart-row{display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:10px}
    .totals{display:grid;gap:6px}
    .totals .row{display:flex;justify-content:space-between}
    .total{font-size:18px;font-weight:800}

    .checkout{display:grid;gap:8px}
    input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a2d33;background:#1b1e24;color:var(--text)}

    .footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}

    @media (max-width:900px){.grid{grid-template-columns:1fr}.menu-list{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">â˜• ä¸€é å¼å’–å•¡è¨‚è³¼</div>
      <div class="pill" id="cart-pill">è³¼ç‰©è»Šï¼š0 ä»¶ï¼ŒNT$ 0</div>
    </header>

    <div class="grid">
      <!-- Left: Products (Tabs, å¾å¾Œç«¯è¼‰å…¥) -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:800;">å•†å“é¸è³¼</div>
          <div class="muted">æ»¿ NT$500 å…é‹</div>
        </div>

        <!-- tabs -->
        <div class="tabs" role="tablist" aria-label="èœå–®åˆ†é¡">
          <button class="tab active" data-target="#panel-gift" role="tab" aria-selected="true">ç¦®ç›’</button>
          <button class="tab" data-target="#panel-drip" role="tab" aria-selected="false">æ›è€³</button>
          <button class="tab" data-target="#panel-beans" role="tab" aria-selected="false">çƒ˜è±†</button>
        </div>

        <div class="menu-panels">
          <div id="panel-gift" class="menu-panel active" role="tabpanel"><div class="menu-list" id="list-gift"></div></div>
          <div id="panel-drip" class="menu-panel" role="tabpanel"><div class="menu-list" id="list-drip"></div></div>
          <div id="panel-beans" class="menu-panel" role="tabpanel"><div class="menu-list" id="list-beans"></div></div>
        </div>
      </div>

      <!-- Right: Cart + Checkout -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:800;">æˆ‘çš„è³¼ç‰©è»Š</div>
          <button id="btnClear" class="btn btn-danger">æ¸…ç©º</button>
        </div>
        <div id="cartList" class="cart-list"></div>
        <div class="totals" id="totals"></div>
        <hr style="border-color:#2a2d33; margin: 12px 0;">
        <div class="checkout">
          <div style="font-weight:800;">æ”¶ä»¶è³‡è¨Š</div>
          <input id="name" placeholder="æ”¶ä»¶äºº*" />
          <input id="phone" placeholder="é›»è©±*" />
          <input id="address" placeholder="åœ°å€*" />
          <textarea id="notes" placeholder="å‚™è¨» (å¯ä¸å¡«)"></textarea>
          <button id="btnCheckout" class="btn-add">é€å‡ºè¨‚å–®</button>
          <div class="muted" id="message"></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Made with Node.js + Express (Session Cart)</div>
      <a class="muted" href="/" rel="noreferrer">å›é¦–é </a>
    </div>
  </div>

<script>
  const nt = n => new Intl.NumberFormat('zh-Hant',{style:'currency',currency:'TWD',maximumFractionDigits:0}).format(n);
  const el = (s) => document.querySelector(s);
  const els = (s) => Array.from(document.querySelectorAll(s));

  async function api(url='', opts={}){
    const res = await fetch(url,{headers:{'Content-Type':'application/json'}, credentials:'include', ...opts});
    if(!res.ok){ const data = await res.json().catch(()=>({})); throw new Error(data.error||'Request error'); }
    return res.json();
  }

  function renderCart(summary){
    const list = el('#cartList');
    const pill = el('#cart-pill');
    const totals = el('#totals');
    list.innerHTML='';
    let count=0; summary.items.forEach(it=>count+=it.quantity);
    pill.textContent = `è³¼ç‰©è»Šï¼š${count} ä»¶ï¼Œ${nt(summary.total)}`;
    if(summary.items.length===0){
      list.innerHTML = '<div class="muted">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>';
    }else{
      summary.items.forEach(item=>{
        const row = document.createElement('div');
        row.className='cart-row';
        row.innerHTML = `
          <div>${item.name}</div>
          <div class="muted">x</div>
          <input type="number" min="0" step="1" value="${item.quantity}" style="width:64px;text-align:center;" />
          <div class="price">${nt(item.lineTotal)}</div>`;
        const qty = row.querySelector('input');
        qty.addEventListener('change', async ()=>{
          const q = Math.max(0, Number(qty.value||0));
          try{ await api('/api/cart/update',{method:'POST',body:JSON.stringify({productId:item.id,quantity:q})}); await refreshCart(); }
          catch(e){ alert(e.message); }
        });
        list.appendChild(row);
      });
    }
    totals.innerHTML = `
      <div class="row"><div>å°è¨ˆ</div><div>${nt(summary.subtotal)}</div></div>
      <div class="row"><div>é‹è²»</div><div>${summary.shipping===0?'å…é‹':nt(summary.shipping)}</div></div>
      <div class="row total"><div>ç¸½è¨ˆ</div><div>${nt(summary.total)}</div></div>`;
  }

  async function refreshCart(){
    const summary = await api('/api/cart');
    renderCart(summary);
  }

  function productEmoji(id) {
    switch(id){
      case 'espresso': return 'â˜•';
      case 'americano': return 'ğŸ¥¤';
      case 'latte': return 'ğŸ¥›';
      case 'cappuccino': return 'ğŸµ';
      case 'mocha': return 'ğŸ«';
      case 'coldbrew': return 'ğŸ§Š';
      default: return 'â˜•';
    }
  }
  function groupCategoryById(id){
    if(id.startsWith('gift_')) return 'gift';
    if(id.startsWith('drip_')) return 'drip';
    if(id.startsWith('beans_')) return 'beans';
    return 'others';
  }

  function renderPanel(listEl, products){
    listEl.innerHTML='';
    products.forEach(p=>{
      const item = document.createElement('div');
      item.className='menu-item';
      // é€™è£¡åŸæœ¬å¯«æˆ div.innerHTMLï¼Œå°è‡´éŒ¯èª¤ï¼›å·²æ”¹ç‚º item.innerHTML
      item.innerHTML = `
        <div class="top">
          <div class="img">${productEmoji(p.id)}</div>
          <div class="meta">
            <div class="name">${p.name}</div>
            <div class="muted">NT$ ${p.price}</div>
          </div>

        </div>
          <div class="qty">
            <button type="button" data-delta="-1">-</button>
            <input type="number" value="1" min="1" step="1" style="width:64px;text-align:center;" />
            <button type="button" data-delta="1">+</button>
          </div>
        <div class="bottom">
          <button class="btn btn-add" data-add="${p.id}">åŠ å…¥</button>
        </div>`;

      const qtyWrap = item.querySelector('.qty');
      const qtyInput = qtyWrap.querySelector('input[type=number]');
      qtyWrap.querySelectorAll('button[data-delta]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const d = Number(btn.dataset.delta||0);
          qtyInput.value = Math.max(1, Number(qtyInput.value||1) + d);
        });
      });

      item.querySelector('.btn-add').addEventListener('click', async ()=>{
        const quantity = Math.max(1, Number(qtyInput.value||1));
        try{ await api('/api/cart/add',{method:'POST',body:JSON.stringify({productId:p.id,quantity})}); await refreshCart(); }
        catch(e){ alert(e.message); }
      });
      listEl.appendChild(item);
    });
  }

  function wireTabs(){
    const tabs = els('.tab');
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      els('.menu-panel').forEach(p=>p.classList.remove('active'));
      const target = document.querySelector(t.dataset.target);
      if(target) target.classList.add('active');
    }));
  }

  async function main(){
    wireTabs();
    // å¾å¾Œç«¯è¼‰å…¥å•†å“ï¼Œä¾ id å‰ç¶´åˆ†çµ„
    try{
      const { products } = await api('/api/products');
      const groups = { gift:[], drip:[], beans:[], others:[] };
      products.forEach(p=>{ groups[groupCategoryById(p.id)].push(p); });
      renderPanel(el('#list-gift'), groups.gift);
      renderPanel(el('#list-drip'), groups.drip);
      renderPanel(el('#list-beans'), groups.beans);
    }catch(e){
      console.error(e);
      alert('è¼‰å…¥å•†å“å¤±æ•—ï¼š'+e.message+'\nè«‹ç¢ºèªä»¥ http://localhost:3000/order.html é–‹å•Ÿï¼Œä¸” /api/products å¯ç”¨ã€‚');
    }

    await refreshCart();

    el('#btnClear').addEventListener('click', async ()=>{ await api('/api/cart/clear',{method:'POST'}); await refreshCart(); });

    el('#btnCheckout').addEventListener('click', async ()=>{
      const name = el('#name').value.trim();
      const phone = el('#phone').value.trim();
      const address = el('#address').value.trim();
      const notes = el('#notes').value.trim();
      el('#message').textContent='å»ºç«‹è¨‚å–®ä¸­â€¦';
      try{
        const data = await api('/api/checkout',{method:'POST',body:JSON.stringify({name,phone,address,notes})});
        el('#message').textContent = `âœ… ${data.message}ï¼ˆè¨‚å–®ç·¨è™Ÿ ${data.orderId}ï¼‰`;
        if(data.redirect){ window.location.href = data.redirect; }
      }catch(e){ el('#message').textContent='âŒ '+e.message; }
    });
  }
  main();
</script>
</body>
</html>