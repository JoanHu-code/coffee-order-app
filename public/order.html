<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å’–å•¡è¨‚è³¼</title>
  <style>
    :root {
      --bg: #0f0f11;
      --card: #16171a;
      --muted: #a7aab0;
      --text: #e9eaee;
      --accent: #8bdc6e;
      --accent-2: #7ab7ff;
      --danger: #ff6b6b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "PingFang TC", "Microsoft JhengHei", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% 0%, #14161a 0%, var(--bg) 70%);
      color: var(--text);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header { display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 16px; }
    .title { font-size: 28px; font-weight: 800; letter-spacing: 0.5px; }
    .pill { background: #1e2025; border: 1px solid #2a2d33; padding: 6px 12px; border-radius: 999px; color: var(--muted); }
    .grid { display: grid; grid-template-columns: 1fr 360px; gap: 16px; }
    .card { background: var(--card); border: 1px solid #2a2d33; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .products { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .product { display: flex; gap: 12px; align-items: center; background: #191b20; border: 1px solid #2a2d33; padding: 10px; border-radius: 14px; }
    .product .img {
      width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg,#2b2e35,#1f2228);
      display: grid; place-items: center; font-size: 26px;
    }
    .product .meta { flex: 1; }
    .name { font-weight: 700; }
    .muted { color: var(--muted); font-size: 13px; }
    .price { font-weight: 700; }
    .qty { display: flex; align-items: center; gap: 6px; }
    button, .btn {
      padding: 8px 12px; border-radius: 12px; border: 1px solid #2a2d33; background: #20232a; color: var(--text);
      cursor: pointer; font-weight: 600;
    }
    .btn-add { background: #1d2b21; border-color: #2d4533; }
    .btn-add:hover { background: #243628; }
    .btn-danger { background: #2b1f1f; border-color: #4a2a2a; color: #ffb3b3; }
    .btn-danger:hover { background: #3a2525; }
    .cart-list { display: grid; gap: 10px; margin: 10px 0 16px; }
    .cart-row { display: grid; grid-template-columns: 1fr auto auto auto; align-items: center; gap: 10px; }
    .totals { display: grid; gap: 6px; }
    .totals .row { display: flex; justify-content: space-between; }
    .total { font-size: 18px; font-weight: 800; }
    .checkout { display: grid; gap: 8px; }
    input, textarea {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #2a2d33; background: #1b1e24; color: var(--text);
    }
    .footer { margin-top: 14px; display: flex; justify-content: space-between; align-items: center; color: var(--muted); font-size: 13px; }
        .product {
    display: flex;
    flex-direction: column; /* æ”¹æˆä¸Šä¸‹æ’åˆ— */
    gap: 8px;
    align-items: stretch;
    background: #191b20;
    border: 1px solid #2a2d33;
    padding: 10px;
    border-radius: 14px;
  }

  .product .top {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .product .meta {
    flex: 1;
  }

  .product .bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto; /* æŠŠæŒ‰éˆ•æ¨åˆ°æœ€åº• */
  }
    .product .bottom .btn-add {
    width: 100%;
    padding: 10px;
    font-weight: 700;
    text-align: center;
  }
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type=number] {
    -moz-appearance: textfield; /* Firefox */
  }
   @media (max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
    .products { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">â˜• ä¸€é å¼å’–å•¡è¨‚è³¼</div>
      <div class="pill" id="cart-pill">è³¼ç‰©è»Šï¼š0 ä»¶ï¼ŒNT$ 0</div>
    </header>

    <div class="grid">
      <!-- Left: Products -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:800;">å’–å•¡å“é …</div>
          <div class="muted">æ»¿ NT$500 å…é‹</div>
        </div>
        <div id="products" class="products"></div>
      </div>

      <!-- Right: Cart + Checkout -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:800;">æˆ‘çš„è³¼ç‰©è»Š</div>
          <button id="btnClear" class="btn btn-danger">æ¸…ç©º</button>
        </div>

        <div id="cartList" class="cart-list"></div>

        <div class="totals" id="totals"></div>

        <hr style="border-color:#2a2d33; margin: 12px 0;">

        <div class="checkout">
          <div style="font-weight:800;">æ”¶ä»¶è³‡è¨Š</div>
          <input id="name" placeholder="æ”¶ä»¶äºº*" />
          <input id="phone" placeholder="é›»è©±*" />
          <input id="address" placeholder="åœ°å€*" />
          <textarea id="notes" placeholder="å‚™è¨» (å¯ä¸å¡«)"></textarea>
          <button id="btnCheckout" class="btn-add">é€å‡ºè¨‚å–®</button>
          <div class="muted" id="message"></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Made with Node.js + Express (Session Cart)</div>
      <a class="muted" href="https://example.com" target="_blank" rel="noreferrer">ç¤ºç¯„é é¢ï¼ˆæœ¬æ©ŸåŸ·è¡Œï¼‰</a>
    </div>
  </div>

<script>
  const nt = n => new Intl.NumberFormat('zh-Hant', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(n);
  const el = (sel) => document.querySelector(sel);

  async function api(url = '', opts = {}) {
    const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...opts });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.error || 'Request error');
    }
    return res.json();
  }

  function productEmoji(id) {
    switch(id){
      case 'espresso': return 'â˜•'; // å°æ¯æ¿ƒç¸®
      case 'americano': return 'ğŸ¥¤'; // å†°æˆ–ç†±ç¾å¼
      case 'latte': return 'ğŸ¥›';
      case 'cappuccino': return 'ğŸµ'; // å¥¶æ³¡æ„Ÿ
      case 'mocha': return 'ğŸ«';
      case 'coldbrew': return 'ğŸ§Š';
      default: return 'â˜•';
    }
  }

  function renderProducts(list) {
    const box = el('#products');
    box.innerHTML = '';
    list.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
      <div class="top">
        <div class="img">${productEmoji(p.id)}</div>
        <div class="meta">
          <div class="name">${p.name}</div>
          <div class="muted">NT$ ${p.price}</div>
        </div>
        <div class="qty">
          <button data-pid="${p.id}" data-delta="-1">-</button>
          <input type="number" value="1" min="1" step="1" style="width:64px;text-align:center;" />
          <button data-pid="${p.id}" data-delta="1">+</button>
        </div>
      </div>
      <div class="bottom">
        <button class="btn btn-add" data-add="${p.id}">åŠ å…¥</button>
      </div>
    `;
      const [minus, qtyInput, plus] = div.querySelectorAll('.qty > *');
      minus.addEventListener('click', () => {
        qtyInput.value = Math.max(1, Number(qtyInput.value || 1) - 1);
      });
      plus.addEventListener('click', () => {
        qtyInput.value = Number(qtyInput.value || 1) + 1;
      });
      div.querySelector('[data-add]').addEventListener('click', async () => {
        const quantity = Number(qtyInput.value || 1);
        await api('/api/cart/add', { method: 'POST', body: JSON.stringify({ productId: p.id, quantity }) });
        await refreshCart();
      });
      box.appendChild(div);
    });
  }

  function renderCart(summary) {
    const list = el('#cartList');
    const pill = el('#cart-pill');
    const totals = el('#totals');
    list.innerHTML = '';

    let count = 0;
    summary.items.forEach(item => { count += item.quantity });

    pill.textContent = `è³¼ç‰©è»Šï¼š${count} ä»¶ï¼Œ${nt(summary.total)}`;

    if (summary.items.length === 0) {
      list.innerHTML = '<div class="muted">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>';
    } else {
      summary.items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div>${item.name}</div>
          <div class="muted">x</div>
          <input type="number" min="0" step="1" value="${item.quantity}" style="width:64px;text-align:center;" />
          <div class="price">${nt(item.lineTotal)}</div>
        `;
        const qtyInput = row.querySelector('input');
        qtyInput.addEventListener('change', async () => {
          const q = Math.max(0, Number(qtyInput.value || 0));
          try {
            await api('/api/cart/update', { method: 'POST', body: JSON.stringify({ productId: item.id, quantity: q }) });
            await refreshCart();
          } catch (e) {
            alert(e.message);
          }
        });
        list.appendChild(row);
      });
    }
    totals.innerHTML = `
      <div class="row"><div>å°è¨ˆ</div><div>${nt(summary.subtotal)}</div></div>
      <div class="row"><div>é‹è²»</div><div>${summary.shipping === 0 ? 'å…é‹' : nt(summary.shipping)}</div></div>
      <div class="row total"><div>ç¸½è¨ˆ</div><div>${nt(summary.total)}</div></div>
    `;
  }

  async function refreshCart() {
    const summary = await api('/api/cart');
    renderCart(summary);
  }

  async function main() {
    const { products } = await api('/api/products');
    renderProducts(products);
    await refreshCart();

    el('#btnClear').addEventListener('click', async () => {
      await api('/api/cart/clear', { method: 'POST' });
      await refreshCart();
    });

      el('#btnCheckout').addEventListener('click', async () => {
        const name = el('#name').value.trim();
        const phone = el('#phone').value.trim();
        const address = el('#address').value.trim();
        const notes = el('#notes').value.trim();
        el('#message').textContent = 'å»ºç«‹è¨‚å–®ä¸­â€¦';
        try {
          const data = await api('/api/checkout', { method: 'POST', body: JSON.stringify({ name, phone, address, notes }) });
          el('#message').textContent = `âœ… ${data.message}ï¼ˆè¨‚å–®ç·¨è™Ÿ ${data.orderId}ï¼‰`;
          // å°å‘å¾Œç«¯çš„ /pay/:orderIdï¼ˆç”±å¾Œç«¯ç”¢ç”Ÿç¶ ç•Œè¡¨å–®ä¸¦è‡ªå‹•é€å‡ºï¼‰
          if (data.redirect) {
            window.location.href = data.redirect;
            return; // å¾ŒçºŒä¸åŸ·è¡Œ
          }
        } catch (e) {
          el('#message').textContent = 'âŒ ' + e.message;
        }
      });
  }
  main();
</script>

</body>
</html>
