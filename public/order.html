<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>咖啡訂購｜Dawit's Coffee</title>
  <style>
    :root { --bg:#0f0f11; --card:#16171a; --muted:#a7aab0; --text:#e9eaee; --accent:#8bdc6e; --accent-2:#7ab7ff; --danger:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"PingFang TC","Microsoft JhengHei",Arial; background:radial-gradient(1200px 600px at 20% 0%, #14161a 0%, var(--bg) 70%); color:var(--text)}
    a{color:inherit}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:16px}
    .title{font-size:28px;font-weight:800;letter-spacing:.5px}
    .pill{background:#1e2025;border:1px solid #2a2d33;padding:6px 12px;border-radius:999px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .card{background:var(--card);border:1px solid #2a2d33;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}

    /* Tabs + menu cards */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tab{padding:8px 12px;border-radius:12px;border:1px solid #2a2d33;background:#1e2025;color:#cfd2d8;font-weight:700;cursor:pointer}
    .tab.active{background:#2a2d33;color:#fff}
    .menu-panel{display:none}
    .menu-panel.active{display:block}
    .menu-list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .menu-item{background:#191b20;border:1px solid #2a2d33;border-radius:14px;padding:12px}
    .menu-item img{width:100%;border-radius:12px;margin-bottom:8px;display:block}
    .name{font-weight:800}
    .muted{color:var(--muted)}
    .stock{font-size:12px;color:var(--muted)}
    .menu-item input[type=number]{text-align:center}

    .top{display:flex;gap:12px;align-items:center}
    .meta{flex:1}

    /* 數量控制：水平且占整行 */
    .qty{
      display:flex;
      width:100%;
      gap:6px;
      margin-top:8px;
      justify-content:center;
    }
    .qty button, .qty input{
      flex:1; min-width:0;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #2a2d33;
      background:#1b1e24;
      color:var(--text);
    }
    .qty input{ max-width:120px; }

    .bottom{margin-top:8px}
    .bottom .btn-add{ width:100%; }
    button,.btn{padding:8px 12px;border-radius:12px;border:1px solid #2a2d33;background:#20232a;color:var(--text);cursor:pointer;font-weight:600;transition:all .15s ease}
    .btn-add{background:#1d2b21;border-color:#2d4533}
    .btn-add:hover{background:#243628}
    .btn-add[disabled]{opacity:.6; cursor:not-allowed;}
    .btn-danger{background:#2b1f1f;border-color:#4a2a2a;color:#ffb3b3}
    .btn-danger:hover{background:#3a2525}

    .cart-list{display:grid;gap:10px;margin:10px 0 16px}
    .cart-row{display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:10px}
    .totals{display:grid;gap:6px}
    .totals .row{display:flex;justify-content:space-between}
    .total{font-size:18px;font-weight:800}

    .checkout{display:grid;gap:8px}
    input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a2d33;background:#1b1e24;color:var(--text)}

    .footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}

    @media (max-width:900px){.grid{grid-template-columns:1fr}.menu-list{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">☕ 一頁式咖啡訂購</div>
      <div class="pill" id="cart-pill">購物車：0 件，NT$ 0</div>
    </header>

    <div class="grid">
      <!-- Left: Products (Tabs, 從後端載入) -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:800;">商品選購</div>
          <div class="muted">滿 NT$500 免運</div>
        </div>

        <!-- tabs -->
        <div class="tabs" role="tablist" aria-label="菜單分類">
          <button class="tab active" data-target="#panel-gift" role="tab" aria-selected="true">禮盒</button>
          <button class="tab" data-target="#panel-drip" role="tab" aria-selected="false">掛耳</button>
          <button class="tab" data-target="#panel-beans" role="tab" aria-selected="false">烘豆</button>
        </div>

        <div class="menu-panels">
          <div id="panel-gift" class="menu-panel active" role="tabpanel"><div class="menu-list" id="list-gift"></div></div>
          <div id="panel-drip" class="menu-panel" role="tabpanel"><div class="menu-list" id="list-drip"></div></div>
          <div id="panel-beans" class="menu-panel" role="tabpanel"><div class="menu-list" id="list-beans"></div></div>
        </div>
      </div>

      <!-- Right: Cart + Checkout -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:800;">我的購物車</div>
          <button id="btnClear" class="btn btn-danger">清空</button>
        </div>
        <div id="cartList" class="cart-list"></div>
        <div class="totals" id="totals"></div>
        <hr style="border-color:#2a2d33; margin: 12px 0;">
        <div class="checkout">
          <div style="font-weight:800;">收件資訊</div>
          <input id="name" placeholder="收件人*" />
          <input id="phone" placeholder="電話*" />
          <input id="address" placeholder="地址*" />
          <textarea id="notes" placeholder="備註 (可不填)"></textarea>
          <button id="btnCheckout" class="btn-add">送出訂單</button>
          <div class="muted" id="message"></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Made with Node.js + Express (Session Cart)</div>
      <a class="muted" href="/" rel="noreferrer">回首頁</a>
    </div>
  </div>

<script>
  const nt = n => new Intl.NumberFormat('zh-Hant',{style:'currency',currency:'TWD',maximumFractionDigits:0}).format(n);
  const el = (s) => document.querySelector(s);
  const els = (s) => Array.from(document.querySelectorAll(s));

  async function api(url='', opts={}){
    const res = await fetch(url,{headers:{'Content-Type':'application/json'}, credentials:'include', ...opts});
    if(!res.ok){ const data = await res.json().catch(()=>({})); throw new Error(data.error||'Request error'); }
    return res.json();
  }

  function renderCart(summary){
    const list = el('#cartList');
    const pill = el('#cart-pill');
    const totals = el('#totals');
    list.innerHTML='';
    let count=0; summary.items.forEach(it=>count+=it.quantity);
    pill.textContent = `購物車：${count} 件，${nt(summary.total)}`;
    if(summary.items.length===0){
      list.innerHTML = '<div class="muted">購物車是空的</div>';
    }else{
      summary.items.forEach(item=>{
        const row = document.createElement('div');
        row.className='cart-row';
        row.innerHTML = `
          <div>${item.name}</div>
          <div class="muted">x</div>
          <input type="number" min="0" step="1" value="${item.quantity}" style="width:64px;text-align:center;" />
          <div class="price">${nt(item.lineTotal)}</div>`;
        const qty = row.querySelector('input');
        qty.addEventListener('change', async ()=>{
          const q = Math.max(0, Number(qty.value||0));
          try{ await api('/api/cart/update',{method:'POST',body:JSON.stringify({productId:item.id,quantity:q})}); await refreshCart(); }
          catch(e){ alert(e.message); }
        });
        list.appendChild(row);
      });
    }
    totals.innerHTML = `
      <div class="row"><div>小計</div><div>${nt(summary.subtotal)}</div></div>
      <div class="row"><div>運費</div><div>${summary.shipping===0?'免運':nt(summary.shipping)}</div></div>
      <div class="row total"><div>總計</div><div>${nt(summary.total)}</div></div>`;
  }

  async function refreshCart(){
    const summary = await api('/api/cart');
    renderCart(summary);
  }

  function groupCategoryById(id){
    if(id.startsWith('gift_')) return 'gift';
    if(id.startsWith('drip_')) return 'drip';
    if(id.startsWith('beans_')) return 'beans';
    return 'others';
  }

  function renderPanel(listEl, products){
    listEl.innerHTML='';
    products.forEach(p=>{
      const item = document.createElement('div');
      item.className='menu-item';
      const soldOut = (p.stock || 0) <= 0;

      item.innerHTML = `
        <img src="${p.img}" alt="${p.name}">
        <div class="top">
          <div class="meta">
            <div class="name">${p.name}</div>
            <div class="muted">NT$ ${p.price}</div>
            <div class="stock">${soldOut ? '庫存：補貨中' : '庫存：' + p.stock}</div>
          </div>
        </div>
        <div class="qty">
          <button type="button" data-delta="-1">-</button>
          <input type="number" value="1" min="1" step="1" ${soldOut ? 'disabled' : ''}/>
          <button type="button" data-delta="1">+</button>
        </div>
        <div class="bottom">
          <button class="btn btn-add" data-add="${p.id}" ${soldOut ? 'disabled' : ''}>${soldOut ? '缺貨' : '加入'}</button>
        </div>`;

      const qtyWrap = item.querySelector('.qty');
      const qtyInput = qtyWrap.querySelector('input[type=number]');
      if (!soldOut) {
        // 設定最大可買數量（不硬性在 input 上限，仍以後端校驗為準）
        qtyWrap.querySelectorAll('button[data-delta]').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const d = Number(btn.dataset.delta||0);
            const next = Math.max(1, Number(qtyInput.value||1) + d);
            qtyInput.value = next;
          });
        });

        item.querySelector('.btn-add').addEventListener('click', async ()=>{
          const quantity = Math.max(1, Number(qtyInput.value||1));
          try{
            if (quantity > p.stock) {
              alert(`庫存不足，剩餘 ${p.stock} 件`);
              return;
            }
            await api('/api/cart/add',{method:'POST',body:JSON.stringify({productId:p.id,quantity})});
            await refreshCart();
          } catch(e){ alert(e.message); }
        });
      }
      listEl.appendChild(item);
    });
  }

  function wireTabs(){
    const tabs = els('.tab');
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      els('.menu-panel').forEach(p=>p.classList.remove('active'));
      const target = document.querySelector(t.dataset.target);
      if(target) target.classList.add('active');
    }));
  }

  async function loadAndRenderProducts(){
    const { products } = await api('/api/products');
    const groups = { gift:[], drip:[], beans:[], others:[] };
    products.forEach(p=>{ groups[groupCategoryById(p.id)].push(p); });
    renderPanel(el('#list-gift'), groups.gift);
    renderPanel(el('#list-drip'), groups.drip);
    renderPanel(el('#list-beans'), groups.beans);
  }

  async function main(){
    wireTabs();
    try{
      await loadAndRenderProducts();
    }catch(e){
      console.error(e);
      alert('載入商品失敗：'+e.message+'\n請確認以 http://localhost:3000/order.html 開啟，且 /api/products 可用。');
    }

    await refreshCart();

    el('#btnClear').addEventListener('click', async ()=>{ await api('/api/cart/clear',{method:'POST'}); await refreshCart(); });

    el('#btnCheckout').addEventListener('click', async ()=>{
      const name = el('#name').value.trim();
      const phone = el('#phone').value.trim();
      const address = el('#address').value.trim();
      const notes = el('#notes').value.trim();
      el('#message').textContent='建立訂單中…';
      try{
        const data = await api('/api/checkout',{method:'POST',body:JSON.stringify({name,phone,address,notes})});
        el('#message').textContent = `✅ ${data.message}（訂單編號 ${data.orderId}）`;
        if(data.redirect){ window.location.href = data.redirect; }
      }catch(e){ el('#message').textContent='❌ '+e.message; }
    });
  }
  main();
</script>
</body>
</html>
